var F=Object.defineProperty;var O=(s,e,t)=>e in s?F(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var R=(s,e,t)=>(O(s,typeof e!="symbol"?e+"":e,t),t);import{c as j,s as M,d as U,u as q}from"./stringify.dbed1f5d.js";import{r as m,k as A,l as p,s as E,j as d,z as D,b as x,A as N}from"../app.d2186bfa.js";import{d as T}from"./debounce.39205130.js";import{t as $}from"./throttle.cc8bbaae.js";const C=new Map,z=(s,e,t)=>{const n=C.get(s);n!=null&&n.timer&&clearTimeout(n.timer);let r;e>-1&&(r=setTimeout(()=>{C.delete(s)},e)),C.set(s,{...t,timer:r})},V=s=>C.get(s),B=new Map,J=s=>B.get(s),Q=(s,e)=>{B.set(s,e),e.then(t=>(B.delete(s),t)).catch(t=>{throw B.delete(s),t})},g={},X=(s,e)=>{g[s]&&g[s].forEach(t=>t(e))},S=(s,e)=>(g[s]||(g[s]=[]),g[s].push(e),function(){const n=g[s].indexOf(e);g[s].splice(n,1)}),Y=(s,{cacheKey:e,cacheTime:t=5*60*1e3,staleTime:n=0,setCache:r,getCache:a})=>{const o=m(),f=m(),l=(u,i)=>{r?r(i):z(u,t,i),X(u,i.data)},v=(u,i=[])=>a?a(i):V(u);return A(()=>{if(!e)return;const u=v(e);u&&Object.hasOwnProperty.call(u,"data")&&(s.state.data=u.data,s.state.params=u.params,console.log("staleTime",n),(n===-1||new Date().getTime()-u.time<=n)&&(s.state.loading=!1)),o.value=S(e,i=>{s.setState({data:i})})}),p(()=>{var u;(u=o.value)==null||u.call(o)}),e?{onBefore:u=>{const i=v(e,u);return!i||!Object.hasOwnProperty.call(i,"data")?{}:n===-1||new Date().getTime()-i.time<=n?(console.log("\u505C\u6B62\u8BF7\u6C42"),{loading:!1,data:i==null?void 0:i.data,returnNow:!0}):{data:i==null?void 0:i.data}},onRequest:(u,i)=>{let c=J(e);return c&&c!==f.value?{servicePromise:c}:(c=u(...i),f.value=c,Q(e,c),{servicePromise:c})},onSuccess:(u,i)=>{var c;e&&((c=o.value)==null||c.call(o),l(e,{data:u,params:i,time:new Date().getTime()}),o.value=S(e,P=>{s.setState({data:P})}))},onMutate:u=>{var i;e&&((i=o.value)==null||i.call(o),l(e,{data:u,params:s.state.params,time:new Date().getTime()}),o.value=S(e,c=>{s.setState({data:c})}))}}:{}},Z=(s,{debounceWait:e,debounceLeading:t,debounceTrailing:n,debounceMaxWait:r})=>{const a=m(),o=E(()=>{const f={},l=d(t)?t.value:t,v=d(n)?n.value:n,u=d(r)?r.value:r;return l!==void 0&&(f.leading=l),v!==void 0&&(f.trailing=v),u!==void 0&&(f.maxWait=u),f});return A(f=>{if(e){const l=s.runAsync.bind(s);a.value=T(v=>{v()},e,o.value),s.runAsync=(...v)=>new Promise((u,i)=>{var c;(c=a.value)==null||c.call(a,()=>{l(...v).then(u).catch(i)})}),f(()=>{var v;(v=a.value)==null||v.cancel(),s.runAsync=l})}}),e?{onCancel:()=>{var f;(f=a.value)==null||f.cancel()}}:{}},G=(s,{loadingDelay:e})=>{const t=m();if(d(e)?!e.value:!e)return{};const n=()=>{t.value&&clearTimeout(t.value)};return{onBefore:()=>(n(),t.value=setTimeout(()=>{s.setState({loading:!0})},d(e)?e.value:e),{loading:!1}),onFinally:()=>{n()},onCancel:()=>{n()}}},y=(s,{pollingInterval:e,pollingWhenHidden:t=!0})=>{const n=m(),r=m(),a=()=>{var o;n.value&&clearInterval(n.value),(o=r.value)==null||o.call(r)};return A(()=>{(d(e)?!(e!=null&&e.value):!e)&&a()}),(d(e)?!(e!=null&&e.value):!e)?{}:{onBefore:()=>{a()},onFinally:()=>{if(!t&&!j()){r.value=M(()=>{s.refresh()});return}n.value=setInterval(()=>{s.refresh()},d(e)?e==null?void 0:e.value:e)},onCancel:()=>{a()}}};function L(s,e){let t=!1;return(...n)=>{t||(t=!0,s(...n),setTimeout(()=>{t=!1},e))}}const W=(s,{refreshOnWindowFocus:e,focusTimespan:t=5e3})=>{const n=m(),r=()=>{var a;(a=n.value)==null||a.call(n)};return A(a=>{if(d(e)?e.value:e){const o=L(s.refresh.bind(s),d(t)?t.value:t);n.value=U(()=>{o()})}a(()=>{r()})}),p(()=>{r()}),{}},k=(s,{retryInterval:e,retryCount:t})=>{const n=m(),r=m(0),a=m(!1);return t?{onBefore:()=>{a.value||(r.value=0),a.value=!1,n.value&&clearTimeout(n.value)},onSuccess:()=>{r.value=0},onError:()=>{if(r.value+=1,t===-1||r.value<=t){const o=e!=null?e:Math.min(1e3*2**r.value,3e4);n.value=setTimeout(()=>{a.value=!0,s.refresh()},o)}else r.value=0},onCancel:()=>{r.value=0,n.value&&clearTimeout(n.value)}}:{}},K=(s,{throttleWait:e,throttleLeading:t,throttleTrailing:n})=>{const r=m(),a={};return(t==null?void 0:t.value)!==void 0&&(a.leading=t.value),(n==null?void 0:n.value)!==void 0&&(a.trailing=n.value),A(o=>{if(e){const f=s.runAsync.bind(s);r.value=$(l=>{l()},e,a),s.runAsync=(...l)=>new Promise((v,u)=>{var i;(i=r.value)==null||i.call(r,()=>{f(...l).then(v).catch(u)})}),o(()=>{var l;s.runAsync=f,(l=r.value)==null||l.cancel()})}}),e?{onCancel:()=>{var o;(o=r.value)==null||o.cancel()}}:{}};class I{constructor(e,t,n,r={}){R(this,"pluginImpls");R(this,"count",0);R(this,"state",{loading:!1,params:void 0,data:void 0,error:void 0});this.serviceRef=e,this.options=t,this.setUpdataData=n,this.initState=r,this.state={...this.state,loading:!t.manual,...r}}setState(e={}){this.state={...this.state,...e},this.setUpdataData(this.state)}setData(e,t){t instanceof Array?t.forEach(n=>{this.state[n]=e,this.setUpdataData(e,n)}):(this.state[t]=e,this.setUpdataData(e,t))}runPluginHandler(e,...t){var r,a,o;const n=(o=(a=(r=this.pluginImpls)==null?void 0:r.map(f=>{var l;return(l=f[e])==null?void 0:l.call(f,...t)}))!=null?a:[])==null?void 0:o.filter(Boolean);return Object.assign({},...n)}async runAsync(...e){var o,f,l,v,u,i,c,P,H,_;this.count+=1;const t=this.count,{stopNow:n=!1,returnNow:r=!1,...a}=this.runPluginHandler("onBefore",e);if(n)return new Promise(()=>{});if(this.setState({loading:!0,params:e,...a}),r)return Promise.resolve(a.data);(f=(o=this.options).onBefore)==null||f.call(o,e);try{let{servicePromise:h}=this.runPluginHandler("onRequest",this.serviceRef.value,e);h||(h=this.serviceRef.value(...e));const b=await h;if(t!==this.count)return new Promise(()=>{});const w=this.options.formatResult?this.options.formatResult(b):b;return this.setState({data:w,error:void 0,loading:!1}),(v=(l=this.options).onSuccess)==null||v.call(l,w,e),this.runPluginHandler("onSuccess",w,e),(i=(u=this.options).onFinally)==null||i.call(u,e,w,void 0),t===this.count&&this.runPluginHandler("onFinally",e,w,void 0),w}catch(h){if(t!==this.count)return new Promise(()=>{});throw this.setState({error:h,loading:!1}),(P=(c=this.options).onError)==null||P.call(c,h,e),this.runPluginHandler("onError",h,e),(_=(H=this.options).onFinally)==null||_.call(H,e,void 0,h),t===this.count&&this.runPluginHandler("onFinally",e,void 0,h),h}}run(...e){this.runAsync(...e).catch(t=>{this.options.onError||console.error(t)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(e){let t;typeof e=="function"?t=e==null?void 0:e(this.state.data):t=e,this.runPluginHandler("onMutate",t),this.setState({data:t})}}function ee(s,e={},t=[]){const{manual:n=!1,ready:r=!0,...a}=e,o={manual:n,ready:r,...a},f=m(s),l=D({data:void 0,loading:!1,params:void 0,error:void 0}),v=(i,c)=>{c?l[c]=i:(l.data=i.data,l.loading=i.loading,l.error=i.error,l.params=i.params)},u=E(()=>{const i=t.map(c=>{var P;return(P=c==null?void 0:c.onInit)==null?void 0:P.call(c,o)}).filter(Boolean);return new I(f,o,v,Object.assign({},...i))});return u.value.options=o,u.value.pluginImpls=t.map(i=>i(u.value,o)),x(()=>{if(!n){const i=u.value.state.params||e.defaultParams||[];(d(r)?r.value:r)&&u.value.run(...i)}}),p(()=>{u.value.cancel()}),{...N(l),cancel:u.value.cancel.bind(u.value),refresh:u.value.refresh.bind(u.value),refreshAsync:u.value.refreshAsync.bind(u.value),run:u.value.run.bind(u.value),runAsync:u.value.runAsync.bind(u.value),mutate:u.value.mutate.bind(u.value)}}function ie(s,e,t){return ee(s,e,[...t||[],Z,G,y,W,K,q,Y,k])}export{ie as u};
