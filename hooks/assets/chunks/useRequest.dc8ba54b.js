var _=Object.defineProperty;var D=(n,e,t)=>e in n?_(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var A=(n,e,t)=>(D(n,typeof e!="symbol"?e+"":e,t),t);import{c as E,s as M,d as T,u as x}from"./stringify.af98eb1c.js";import{r as d,l as w,k as B,s as O,u as m,z as U,b as j,A as q}from"../app.34efe815.js";import{d as N}from"./debounce.45f1f75f.js";import{t as $}from"./throttle.04a5f1d9.js";const R=new Map,y=(n,e,t)=>{const s=R.get(n);s!=null&&s.timer&&clearTimeout(s.timer);let o;e>-1&&(o=setTimeout(()=>{R.delete(n)},e)),R.set(n,{...t,timer:o})},z=n=>R.get(n),b=new Map,V=n=>b.get(n),J=(n,e)=>{b.set(n,e),e.then(t=>(b.delete(n),t)).catch(t=>{throw b.delete(n),t})},P={},Q=(n,e)=>{P[n]&&P[n].forEach(t=>t(e))},C=(n,e)=>(P[n]||(P[n]=[]),P[n].push(e),function(){const s=P[n].indexOf(e);P[n].splice(s,1)}),X=(n,{cacheKey:e,cacheTime:t=5*60*1e3,staleTime:s=0,setCache:o,getCache:a})=>{const u=d(),f=d(),l=(r,i)=>{o?o(i):y(r,t,i),Q(r,i.data)},v=(r,i=[])=>a?a(i):z(r);return w(()=>{if(!e)return;const r=v(e);r&&Object.hasOwnProperty.call(r,"data")&&(n.state.data=r.data,n.state.params=r.params,console.log("staleTime",s),(s===-1||new Date().getTime()-r.time<=s)&&(n.state.loading=!1)),u.value=C(e,i=>{n.setState({data:i})})}),B(()=>{var r;(r=u.value)==null||r.call(u)}),e?{onBefore:r=>{const i=v(e,r);return!i||!Object.hasOwnProperty.call(i,"data")?{}:s===-1||new Date().getTime()-i.time<=s?(console.log("\u505C\u6B62\u8BF7\u6C42"),{loading:!1,data:i==null?void 0:i.data,returnNow:!0}):{data:i==null?void 0:i.data}},onRequest:(r,i)=>{let c=V(e);return c&&c!==f.value?{servicePromise:c}:(c=r(...i),f.value=c,J(e,c),{servicePromise:c})},onSuccess:(r,i)=>{var c;e&&((c=u.value)==null||c.call(u),l(e,{data:r,params:i,time:new Date().getTime()}),u.value=C(e,h=>{n.setState({data:h})}))},onMutate:r=>{var i;e&&((i=u.value)==null||i.call(u),l(e,{data:r,params:n.state.params,time:new Date().getTime()}),u.value=C(e,c=>{n.setState({data:c})}))}}:{}},Y=(n,{debounceWait:e,debounceLeading:t,debounceTrailing:s,debounceMaxWait:o})=>{const a=d(),u=O(()=>{const f={},l=m(t),v=m(s),r=m(o);return l!==void 0&&(f.leading=l),v!==void 0&&(f.trailing=v),r!==void 0&&(f.maxWait=r),f});return w(f=>{if(e){const l=n.runAsync.bind(n);a.value=N(v=>{v()},e,u.value),n.runAsync=(...v)=>new Promise((r,i)=>{var c;(c=a.value)==null||c.call(a,()=>{l(...v).then(r).catch(i)})}),f(()=>{var v;(v=a.value)==null||v.cancel(),n.runAsync=l})}}),e?{onCancel:()=>{var f;(f=a.value)==null||f.cancel()}}:{}},Z=(n,{loadingDelay:e})=>{const t=d();if(!m(e))return{};const s=()=>{t.value&&clearTimeout(t.value)};return{onBefore:()=>(s(),t.value=setTimeout(()=>{n.setState({loading:!0})},m(e)),{loading:!1}),onFinally:()=>{s()},onCancel:()=>{s()}}},G=(n,{pollingInterval:e,pollingWhenHidden:t=!0})=>{const s=d(),o=d(),a=()=>{var u;s.value&&clearInterval(s.value),(u=o.value)==null||u.call(o)};return w(()=>{m(e)||a()}),m(e)?{onBefore:()=>{a()},onFinally:()=>{if(!t&&!E()){o.value=M(()=>{n.refresh()});return}s.value=setInterval(()=>{n.refresh()},m(e))},onCancel:()=>{a()}}:{}};function W(n,e){let t=!1;return(...s)=>{t||(t=!0,n(...s),setTimeout(()=>{t=!1},e))}}const L=(n,{refreshOnWindowFocus:e,focusTimespan:t=5e3})=>{const s=d(),o=()=>{var a;(a=s.value)==null||a.call(s)};return w(a=>{if(m(e)){const u=W(n.refresh.bind(n),m(t));s.value=T(()=>{u()})}a(()=>{o()})}),B(()=>{o()}),{}},k=(n,{retryInterval:e,retryCount:t})=>{const s=d(),o=d(0),a=d(!1);return t?{onBefore:()=>{a.value||(o.value=0),a.value=!1,s.value&&clearTimeout(s.value)},onSuccess:()=>{o.value=0},onError:()=>{if(o.value+=1,t===-1||o.value<=t){const u=e!=null?e:Math.min(1e3*2**o.value,3e4);s.value=setTimeout(()=>{a.value=!0,n.refresh()},u)}else o.value=0},onCancel:()=>{o.value=0,s.value&&clearTimeout(s.value)}}:{}},I=(n,{throttleWait:e,throttleLeading:t,throttleTrailing:s})=>{const o=d(),a={};return(t==null?void 0:t.value)!==void 0&&(a.leading=t.value),(s==null?void 0:s.value)!==void 0&&(a.trailing=s.value),w(u=>{if(e){const f=n.runAsync.bind(n);o.value=$(l=>{l()},e,a),n.runAsync=(...l)=>new Promise((v,r)=>{var i;(i=o.value)==null||i.call(o,()=>{f(...l).then(v).catch(r)})}),u(()=>{var l;n.runAsync=f,(l=o.value)==null||l.cancel()})}}),e?{onCancel:()=>{var u;(u=o.value)==null||u.cancel()}}:{}};class K{constructor(e,t,s,o={}){A(this,"pluginImpls");A(this,"count",0);A(this,"state",{loading:!1,params:void 0,data:void 0,error:void 0});this.serviceRef=e,this.options=t,this.setUpdataData=s,this.initState=o,this.state={...this.state,loading:!t.manual,...o}}setState(e={}){this.state={...this.state,...e},this.setUpdataData(this.state)}setData(e,t){t instanceof Array?t.forEach(s=>{this.state[s]=e,this.setUpdataData(e,s)}):(this.state[t]=e,this.setUpdataData(e,t))}runPluginHandler(e,...t){var o,a,u;const s=(u=(a=(o=this.pluginImpls)==null?void 0:o.map(f=>{var l;return(l=f[e])==null?void 0:l.call(f,...t)}))!=null?a:[])==null?void 0:u.filter(Boolean);return Object.assign({},...s)}async runAsync(...e){var u,f,l,v,r,i,c,h,S,F;this.count+=1;const t=this.count,{stopNow:s=!1,returnNow:o=!1,...a}=this.runPluginHandler("onBefore",e);if(s)return new Promise(()=>{});if(this.setState({loading:!0,params:e,...a}),o)return Promise.resolve(a.data);(f=(u=this.options).onBefore)==null||f.call(u,e);try{let{servicePromise:g}=this.runPluginHandler("onRequest",this.serviceRef.value,e);g||(g=this.serviceRef.value(...e));const H=await g;if(t!==this.count)return new Promise(()=>{});const p=this.options.formatResult?this.options.formatResult(H):H;return this.setState({data:p,error:void 0,loading:!1}),(v=(l=this.options).onSuccess)==null||v.call(l,p,e),this.runPluginHandler("onSuccess",p,e),(i=(r=this.options).onFinally)==null||i.call(r,e,p,void 0),t===this.count&&this.runPluginHandler("onFinally",e,p,void 0),p}catch(g){if(t!==this.count)return new Promise(()=>{});throw this.setState({error:g,loading:!1}),(h=(c=this.options).onError)==null||h.call(c,g,e),this.runPluginHandler("onError",g,e),(F=(S=this.options).onFinally)==null||F.call(S,e,void 0,g),t===this.count&&this.runPluginHandler("onFinally",e,void 0,g),g}}run(...e){this.runAsync(...e).catch(t=>{this.options.onError||console.error(t)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(e){let t;typeof e=="function"?t=e==null?void 0:e(this.state.data):t=e,this.runPluginHandler("onMutate",t),this.setState({data:t})}}function ee(n,e={},t=[]){const{manual:s=!1,ready:o=!0,...a}=e,u={manual:s,ready:o,...a},f=d(n),l=U({data:void 0,loading:!1,params:void 0,error:void 0}),v=(i,c)=>{c?l[c]=i:(l.data=i.data,l.loading=i.loading,l.error=i.error,l.params=i.params)},r=O(()=>{const i=t.map(c=>{var h;return(h=c==null?void 0:c.onInit)==null?void 0:h.call(c,u)}).filter(Boolean);return new K(f,u,v,Object.assign({},...i))});return r.value.options=u,r.value.pluginImpls=t.map(i=>i(r.value,u)),j(()=>{if(!s){const i=r.value.state.params||e.defaultParams||[];m(o)&&r.value.run(...i)}}),B(()=>{r.value.cancel()}),{...q(l),cancel:r.value.cancel.bind(r.value),refresh:r.value.refresh.bind(r.value),refreshAsync:r.value.refreshAsync.bind(r.value),run:r.value.run.bind(r.value),runAsync:r.value.runAsync.bind(r.value),mutate:r.value.mutate.bind(r.value)}}function oe(n,e,t){return ee(n,e,[...t||[],Y,Z,G,L,I,x,X,k])}export{oe as u};
