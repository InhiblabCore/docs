var O=Object.defineProperty;var _=(n,e,t)=>e in n?O(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var A=(n,e,t)=>(_(n,typeof e!="symbol"?e+"":e,t),t);import{c as D,s as E,d as M,u as x}from"./stringify.72f98ff7.js";import{r as m,l as w,k as S,s as C,u as v,z as U,b as j,A as q}from"../app.3f3e34b8.js";import{d as N}from"./debounce.1fb9583f.js";import{t as $}from"./throttle.194e3921.js";const R=new Map,y=(n,e,t)=>{const s=R.get(n);s!=null&&s.timer&&clearTimeout(s.timer);let a;e>-1&&(a=setTimeout(()=>{R.delete(n)},e)),R.set(n,{...t,timer:a})},z=n=>R.get(n),b=new Map,L=n=>b.get(n),V=(n,e)=>{b.set(n,e),e.then(t=>(b.delete(n),t)).catch(t=>{throw b.delete(n),t})},P={},J=(n,e)=>{P[n]&&P[n].forEach(t=>t(e))},B=(n,e)=>(P[n]||(P[n]=[]),P[n].push(e),function(){const s=P[n].indexOf(e);P[n].splice(s,1)}),Q=(n,{cacheKey:e,cacheTime:t=5*60*1e3,staleTime:s=0,setCache:a,getCache:u})=>{const o=m(),f=m(),c=(r,i)=>{a?a(i):y(r,t,i),J(r,i.data)},d=(r,i=[])=>u?u(i):z(r);return w(()=>{if(!e)return;const r=d(e);r&&Object.hasOwnProperty.call(r,"data")&&(n.state.data=r.data,n.state.params=r.params,console.log("staleTime",s),(s===-1||new Date().getTime()-r.time<=s)&&(n.state.loading=!1)),o.value=B(e,i=>{n.setState({data:i})})}),S(()=>{var r;(r=o.value)==null||r.call(o)}),e?{onBefore:r=>{const i=d(e,r);return!i||!Object.hasOwnProperty.call(i,"data")?{}:s===-1||new Date().getTime()-i.time<=s?(console.log("\u505C\u6B62\u8BF7\u6C42"),{loading:!1,data:i==null?void 0:i.data,returnNow:!0}):{data:i==null?void 0:i.data}},onRequest:(r,i)=>{let l=L(e);return l&&l!==f.value?{servicePromise:l}:(l=r(...i),f.value=l,V(e,l),{servicePromise:l})},onSuccess:(r,i)=>{var l;e&&((l=o.value)==null||l.call(o),c(e,{data:r,params:i,time:new Date().getTime()}),o.value=B(e,h=>{n.setState({data:h})}))},onMutate:r=>{var i;e&&((i=o.value)==null||i.call(o),c(e,{data:r,params:n.state.params,time:new Date().getTime()}),o.value=B(e,l=>{n.setState({data:l})}))}}:{}},X=(n,{debounceWait:e,debounceLeading:t,debounceTrailing:s,debounceMaxWait:a})=>{const u=m(),o=C(()=>{const f={},c=v(t),d=v(s),r=v(a);return c!==void 0&&(f.leading=c),d!==void 0&&(f.trailing=d),r!==void 0&&(f.maxWait=r),f});return w(f=>{if(v(e)){const c=n.runAsync.bind(n);u.value=N(d=>{d()},v(e),o.value),n.runAsync=(...d)=>new Promise((r,i)=>{var l;(l=u.value)==null||l.call(u,()=>{c(...d).then(r).catch(i)})}),f(()=>{var d;(d=u.value)==null||d.cancel(),n.runAsync=c})}}),v(e)?{onCancel:()=>{var f;(f=u.value)==null||f.cancel()}}:{}},Y=(n,{loadingDelay:e})=>{const t=m();if(!v(e))return{};const s=()=>{t.value&&clearTimeout(t.value)};return{onBefore:()=>(s(),t.value=setTimeout(()=>{n.setState({loading:!0})},v(e)),{loading:!1}),onFinally:()=>{s()},onCancel:()=>{s()}}},Z=(n,{pollingInterval:e,pollingWhenHidden:t=!0})=>{const s=m(),a=m(),u=()=>{var o;s.value&&clearInterval(s.value),(o=a.value)==null||o.call(a)};return w(()=>{v(e)||u()}),v(e)?{onBefore:()=>{u()},onFinally:()=>{if(!t&&!D()){a.value=E(()=>{n.refresh()});return}s.value=setInterval(()=>{n.refresh()},v(e))},onCancel:()=>{u()}}:{}};function G(n,e){let t=!1;return(...s)=>{t||(t=!0,n(...s),setTimeout(()=>{t=!1},e))}}const W=(n,{refreshOnWindowFocus:e,focusTimespan:t=5e3})=>{const s=m(),a=()=>{var u;(u=s.value)==null||u.call(s)};return w(u=>{if(v(e)){const o=G(n.refresh.bind(n),v(t));s.value=M(()=>{o()})}u(()=>{a()})}),S(()=>{a()}),{}},k=(n,{retryInterval:e,retryCount:t})=>{const s=m(),a=m(0),u=m(!1);return t?{onBefore:()=>{u.value||(a.value=0),u.value=!1,s.value&&clearTimeout(s.value)},onSuccess:()=>{a.value=0},onError:()=>{if(a.value+=1,t===-1||a.value<=t){const o=e!=null?e:Math.min(1e3*2**a.value,3e4);s.value=setTimeout(()=>{u.value=!0,n.refresh()},o)}else a.value=0},onCancel:()=>{a.value=0,s.value&&clearTimeout(s.value)}}:{}},I=(n,{throttleWait:e,throttleLeading:t,throttleTrailing:s})=>{const a=C(()=>{const o={};return v(t)!==void 0&&(o.leading=v(t)),v(s)!==void 0&&(o.trailing=v(s)),o}),u=C(()=>$(o=>{o()},v(e),a.value));return w(o=>{if(v(e)){const f=n.runAsync.bind(n);n.runAsync=(...c)=>new Promise((d,r)=>{var i;(i=u.value)==null||i.call(u,()=>{f(...c).then(d).catch(r)})}),o(()=>{var c;n.runAsync=f,(c=u.value)==null||c.cancel()})}}),v(e)?{onCancel:()=>{var o;(o=u.value)==null||o.cancel()}}:{}};class K{constructor(e,t,s,a={}){A(this,"pluginImpls");A(this,"count",0);A(this,"state",{loading:!1,params:void 0,data:void 0,error:void 0});this.serviceRef=e,this.options=t,this.setUpdataData=s,this.initState=a,this.state={...this.state,loading:!t.manual,...a}}setState(e={}){this.state={...this.state,...e},this.setUpdataData(this.state)}setData(e,t){t instanceof Array?t.forEach(s=>{this.state[s]=e,this.setUpdataData(e,s)}):(this.state[t]=e,this.setUpdataData(e,t))}runPluginHandler(e,...t){var a,u,o;const s=(o=(u=(a=this.pluginImpls)==null?void 0:a.map(f=>{var c;return(c=f[e])==null?void 0:c.call(f,...t)}))!=null?u:[])==null?void 0:o.filter(Boolean);return Object.assign({},...s)}async runAsync(...e){var o,f,c,d,r,i,l,h,T,F;this.count+=1;const t=this.count,{stopNow:s=!1,returnNow:a=!1,...u}=this.runPluginHandler("onBefore",e);if(s)return new Promise(()=>{});if(this.setState({loading:!0,params:e,...u}),a)return Promise.resolve(u.data);(f=(o=this.options).onBefore)==null||f.call(o,e);try{let{servicePromise:g}=this.runPluginHandler("onRequest",this.serviceRef.value,e);g||(g=this.serviceRef.value(...e));const H=await g;if(t!==this.count)return new Promise(()=>{});const p=this.options.formatResult?this.options.formatResult(H):H;return this.setState({data:p,error:void 0,loading:!1}),(d=(c=this.options).onSuccess)==null||d.call(c,p,e),this.runPluginHandler("onSuccess",p,e),(i=(r=this.options).onFinally)==null||i.call(r,e,p,void 0),t===this.count&&this.runPluginHandler("onFinally",e,p,void 0),p}catch(g){if(t!==this.count)return new Promise(()=>{});throw this.setState({error:g,loading:!1}),(h=(l=this.options).onError)==null||h.call(l,g,e),this.runPluginHandler("onError",g,e),(F=(T=this.options).onFinally)==null||F.call(T,e,void 0,g),t===this.count&&this.runPluginHandler("onFinally",e,void 0,g),g}}run(...e){this.runAsync(...e).catch(t=>{this.options.onError||console.error(t)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(e){let t;typeof e=="function"?t=e==null?void 0:e(this.state.data):t=e,this.runPluginHandler("onMutate",t),this.setState({data:t})}}function ee(n,e={},t=[]){const{manual:s=!1,ready:a=!0,...u}=e,o={manual:s,ready:a,...u},f=m(n),c=U({data:void 0,loading:!1,params:void 0,error:void 0}),d=(i,l)=>{l?c[l]=i:(c.data=i.data,c.loading=i.loading,c.error=i.error,c.params=i.params)},r=C(()=>{const i=t.map(l=>{var h;return(h=l==null?void 0:l.onInit)==null?void 0:h.call(l,o)}).filter(Boolean);return new K(f,o,d,Object.assign({},...i))});return r.value.options=o,r.value.pluginImpls=t.map(i=>i(r.value,o)),j(()=>{if(!s){const i=r.value.state.params||e.defaultParams||[];v(a)&&r.value.run(...i)}}),S(()=>{r.value.cancel()}),{...q(c),cancel:r.value.cancel.bind(r.value),refresh:r.value.refresh.bind(r.value),refreshAsync:r.value.refreshAsync.bind(r.value),run:r.value.run.bind(r.value),runAsync:r.value.runAsync.bind(r.value),mutate:r.value.mutate.bind(r.value)}}function oe(n,e,t){return ee(n,e,[...t||[],X,Y,Z,W,I,x,Q,k])}export{oe as u};
