var _=Object.defineProperty;var M=(n,t,e)=>t in n?_(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var R=(n,t,e)=>(M(n,typeof t!="symbol"?t+"":t,e),e);import{d as E,s as q,f as x,u as U}from"./stringify.f8dcadb6.js";import{r as m,l as w,k as D,s as C,u as v,z as j,h as N,A as $}from"../app.9c682a42.js";import{d as y}from"./debounce.ba86be06.js";import{t as z}from"./throttle.8d995e36.js";const b=new Map,L=(n,t,e)=>{const s=b.get(n);s!=null&&s.timer&&clearTimeout(s.timer);let a;t>-1&&(a=setTimeout(()=>{b.delete(n)},t)),b.set(n,{...e,timer:a})},V=n=>b.get(n),S=new Map,J=n=>S.get(n),Q=(n,t)=>{S.set(n,t),t.then(e=>(S.delete(n),e)).catch(e=>{throw S.delete(n),e})},P={},X=(n,t)=>{P[n]&&P[n].forEach(e=>e(t))},B=(n,t)=>(P[n]||(P[n]=[]),P[n].push(t),function(){const s=P[n].indexOf(t);P[n].splice(s,1)}),Y=(n,{cacheKey:t,cacheTime:e=5*60*1e3,staleTime:s=0,setCache:a,getCache:o})=>{const r=m(),c=m(),d=(l,u)=>{a?a(u):L(l,e,u),X(l,u.data)},f=(l,u=[])=>o?o(u):V(l);return w(()=>{if(!t)return;const l=f(t);l&&Object.hasOwnProperty.call(l,"data")&&(n.state.data=l.data,n.state.params=l.params,console.log("staleTime",s),(s===-1||new Date().getTime()-l.time<=s)&&(n.state.loading=!1)),r.value=B(t,u=>{n.setState({data:u})})}),D(()=>{var l;(l=r.value)==null||l.call(r)}),t?{onBefore:l=>{const u=f(t,l);return!u||!Object.hasOwnProperty.call(u,"data")?{}:s===-1||new Date().getTime()-u.time<=s?(console.log("\u505C\u6B62\u8BF7\u6C42"),{loading:!1,data:u==null?void 0:u.data,returnNow:!0}):{data:u==null?void 0:u.data}},onRequest:(l,u)=>{let i=J(t);return i&&i!==c.value?{servicePromise:i}:(i=l(...u),c.value=i,Q(t,i),{servicePromise:i})},onSuccess:(l,u)=>{var i;t&&((i=r.value)==null||i.call(r),d(t,{data:l,params:u,time:new Date().getTime()}),r.value=B(t,h=>{n.setState({data:h})}))},onMutate:l=>{var u;t&&((u=r.value)==null||u.call(r),d(t,{data:l,params:n.state.params,time:new Date().getTime()}),r.value=B(t,i=>{n.setState({data:i})}))}}:{}},Z=(n,{debounceWait:t,debounceLeading:e,debounceTrailing:s,debounceMaxWait:a})=>{const o=m(),r=C(()=>{const c={},d=v(e),f=v(s),l=v(a);return d!==void 0&&(c.leading=d),f!==void 0&&(c.trailing=f),l!==void 0&&(c.maxWait=l),c});return w(c=>{if(v(t)){const d=n.runAsync.bind(n);o.value=y(f=>{f()},v(t),r.value),n.runAsync=(...f)=>new Promise((l,u)=>{var i;(i=o.value)==null||i.call(o,()=>{d(...f).then(l).catch(u)})}),c(()=>{var f;(f=o.value)==null||f.cancel(),n.runAsync=d})}}),v(t)?{onCancel:()=>{var c;(c=o.value)==null||c.cancel()}}:{}},G=(n,{loadingDelay:t})=>{const e=m();if(!v(t))return{};const s=()=>{e.value&&clearTimeout(e.value)};return{onBefore:()=>(s(),e.value=setTimeout(()=>{n.setState({loading:!0})},v(t)),{loading:!1}),onFinally:()=>{s()},onCancel:()=>{s()}}},W=(n,{pollingInterval:t,pollingWhenHidden:e=!0,pollingErrorRetryCount:s=-1})=>{const a=m(),o=m(),r=m(0),c=()=>{var d;a.value&&clearInterval(a.value),(d=o.value)==null||d.call(o)};return w(()=>{v(t)||c()}),v(t)?{onBefore:()=>{c()},onError:()=>{r.value+=1},onSuccess:()=>{r.value=0},onFinally:()=>{s===-1||s!==-1&&r.value<=s?a.value=setTimeout(()=>{!e&&!E()?o.value=q(()=>{n.refresh()}):n.refresh()},v(t)):r.value=0},onCancel:()=>{c()}}:{}};function k(n,t){let e=!1;return(...s)=>{e||(e=!0,n(...s),setTimeout(()=>{e=!1},t))}}const I=(n,{refreshOnWindowFocus:t,focusTimespan:e=5e3})=>{const s=m(),a=()=>{var o;(o=s.value)==null||o.call(s)};return w(o=>{if(v(t)){const r=k(n.refresh.bind(n),v(e));s.value=x(()=>{r()})}o(()=>{a()})}),D(()=>{a()}),{}},K=(n,{retryInterval:t,retryCount:e})=>{const s=m(),a=m(0),o=m(!1);return e?{onBefore:()=>{o.value||(a.value=0),o.value=!1,s.value&&clearTimeout(s.value)},onSuccess:()=>{a.value=0},onError:()=>{if(a.value+=1,e===-1||a.value<=e){const r=t!=null?t:Math.min(1e3*2**a.value,3e4);s.value=setTimeout(()=>{o.value=!0,n.refresh()},r)}else a.value=0},onCancel:()=>{a.value=0,s.value&&clearTimeout(s.value)}}:{}},tt=(n,{throttleWait:t,throttleLeading:e,throttleTrailing:s})=>{const a=C(()=>{const r={};return v(e)!==void 0&&(r.leading=v(e)),v(s)!==void 0&&(r.trailing=v(s)),r}),o=C(()=>z(r=>{r()},v(t),a.value));return w(r=>{if(v(t)){const c=n.runAsync.bind(n);n.runAsync=(...d)=>new Promise((f,l)=>{var u;(u=o.value)==null||u.call(o,()=>{c(...d).then(f).catch(l)})}),r(()=>{var d;n.runAsync=c,(d=o.value)==null||d.cancel()})}}),v(t)?{onCancel:()=>{var r;(r=o.value)==null||r.cancel()}}:{}};class et{constructor(t,e,s,a={}){R(this,"pluginImpls");R(this,"count",0);R(this,"state",{loading:!1,params:void 0,data:void 0,error:void 0});this.serviceRef=t,this.options=e,this.setUpdateData=s,this.initState=a,this.state={...this.state,loading:!e.manual,...a}}setState(t={}){this.state={...this.state,...t},this.setUpdateData(this.state)}setData(t,e){e instanceof Array?e.forEach(s=>{this.state[s]=t,this.setUpdateData(t,s)}):(this.state[e]=t,this.setUpdateData(t,e))}runPluginHandler(t,...e){var a,o,r;const s=(r=(o=(a=this.pluginImpls)==null?void 0:a.map(c=>{var d;return(d=c[t])==null?void 0:d.call(c,...e)}))!=null?o:[])==null?void 0:r.filter(Boolean);return Object.assign({},...s)}async runAsync(...t){var r,c,d,f,l,u;this.count+=1;const e=this.count,{stopNow:s=!1,returnNow:a=!1,...o}=this.runPluginHandler("onBefore",t);if(s)return new Promise(()=>{});if(this.setState({loading:!0,params:t,...o}),a)return Promise.resolve(o.data);(c=(r=this.options).onBefore)==null||c.call(r,t);try{let{servicePromise:i}=this.runPluginHandler("onRequest",this.serviceRef.value,t);const h=A=>{var T,F,H,O;if(e!==this.count)return new Promise(()=>{});const p=this.options.formatResult?this.options.formatResult(A):A;return this.setState({data:p,error:void 0,loading:!1}),(F=(T=this.options).onSuccess)==null||F.call(T,p,t),this.runPluginHandler("onSuccess",p,t),(O=(H=this.options).onFinally)==null||O.call(H,t,p,void 0),e===this.count&&this.runPluginHandler("onFinally",t,p,void 0),p};i||(!this.options.manual&&this.options.refreshDeps===!0?w(async()=>{if(v(this.options.ready)){this.setData(!0,"loading"),i=this.serviceRef.value(...t);const A=await i;return h(A)}}):i=this.serviceRef.value(...t));const g=await i;return h(g)}catch(i){if(e!==this.count)return new Promise(()=>{});throw this.setState({error:i,loading:!1}),(f=(d=this.options).onError)==null||f.call(d,i,t),this.runPluginHandler("onError",i,t),(u=(l=this.options).onFinally)==null||u.call(l,t,void 0,i),e===this.count&&this.runPluginHandler("onFinally",t,void 0,i),i}}run(...t){this.runAsync(...t).catch(e=>{this.options.onError||console.error(e)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(t){let e;typeof t=="function"?e=t==null?void 0:t(this.state.data):e=t,this.runPluginHandler("onMutate",e),this.setState({data:e})}}function nt(n,t={},e=[]){const{initialData:s=void 0,manual:a=!1,ready:o=!0,...r}=t,c={manual:a,ready:o,...r},d=m(n),f=j({data:s,loading:!1,params:void 0,error:void 0}),l=(h,g)=>{g?f[g]=h:(f.data=h.data,f.loading=h.loading,f.error=h.error,f.params=h.params)},u=e.map(h=>{var g;return(g=h==null?void 0:h.onInit)==null?void 0:g.call(h,c)}).filter(Boolean),i=new et(d,c,l,Object.assign({},...u,f));return i.options=c,i.pluginImpls=e.map(h=>h(i,c)),N(()=>{if(!a){const h=i.state.params||t.defaultParams||[];v(o)&&i.run(...h)}}),D(()=>{i.cancel()}),{...$(f),cancel:i.cancel.bind(i),refresh:i.refresh.bind(i),refreshAsync:i.refreshAsync.bind(i),run:i.run.bind(i),runAsync:i.runAsync.bind(i),mutate:i.mutate.bind(i)}}function ut(n,t,e){return nt(n,t,[...e||[],Z,G,W,I,tt,U,Y,K])}export{ut as u};
