var H=Object.defineProperty;var O=(n,t,e)=>t in n?H(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var R=(n,t,e)=>(O(n,typeof t!="symbol"?t+"":t,e),e);import{d as _,s as M,f as E,u as x}from"./stringify.d180ea33.js";import{r as g,l as A,k as T,s as C,u as v,z as U,h as j,A as q}from"../app.9c682a42.js";import{d as N}from"./debounce.bdef167c.js";import{t as $}from"./throttle.9de608fb.js";const b=new Map,z=(n,t,e)=>{const s=b.get(n);s!=null&&s.timer&&clearTimeout(s.timer);let a;t>-1&&(a=setTimeout(()=>{b.delete(n)},t)),b.set(n,{...e,timer:a})},L=n=>b.get(n),S=new Map,V=n=>S.get(n),J=(n,t)=>{S.set(n,t),t.then(e=>(S.delete(n),e)).catch(e=>{throw S.delete(n),e})},p={},Q=(n,t)=>{p[n]&&p[n].forEach(e=>e(t))},B=(n,t)=>(p[n]||(p[n]=[]),p[n].push(t),function(){const s=p[n].indexOf(t);p[n].splice(s,1)}),X=(n,{cacheKey:t,cacheTime:e=5*60*1e3,staleTime:s=0,setCache:a,getCache:o})=>{const i=g(),c=g(),d=(l,u)=>{a?a(u):z(l,e,u),Q(l,u.data)},f=(l,u=[])=>o?o(u):L(l);return A(()=>{if(!t)return;const l=f(t);l&&Object.hasOwnProperty.call(l,"data")&&(n.state.data=l.data,n.state.params=l.params,console.log("staleTime",s),(s===-1||new Date().getTime()-l.time<=s)&&(n.state.loading=!1)),i.value=B(t,u=>{n.setState({data:u})})}),T(()=>{var l;(l=i.value)==null||l.call(i)}),t?{onBefore:l=>{const u=f(t,l);return!u||!Object.hasOwnProperty.call(u,"data")?{}:s===-1||new Date().getTime()-u.time<=s?(console.log("\u505C\u6B62\u8BF7\u6C42"),{loading:!1,data:u==null?void 0:u.data,returnNow:!0}):{data:u==null?void 0:u.data}},onRequest:(l,u)=>{let r=V(t);return r&&r!==c.value?{servicePromise:r}:(r=l(...u),c.value=r,J(t,r),{servicePromise:r})},onSuccess:(l,u)=>{var r;t&&((r=i.value)==null||r.call(i),d(t,{data:l,params:u,time:new Date().getTime()}),i.value=B(t,m=>{n.setState({data:m})}))},onMutate:l=>{var u;t&&((u=i.value)==null||u.call(i),d(t,{data:l,params:n.state.params,time:new Date().getTime()}),i.value=B(t,r=>{n.setState({data:r})}))}}:{}},Y=(n,{debounceWait:t,debounceLeading:e,debounceTrailing:s,debounceMaxWait:a})=>{const o=g(),i=C(()=>{const c={},d=v(e),f=v(s),l=v(a);return d!==void 0&&(c.leading=d),f!==void 0&&(c.trailing=f),l!==void 0&&(c.maxWait=l),c});return A(c=>{if(v(t)){const d=n.runAsync.bind(n);o.value=N(f=>{f()},v(t),i.value),n.runAsync=(...f)=>new Promise((l,u)=>{var r;(r=o.value)==null||r.call(o,()=>{d(...f).then(l).catch(u)})}),c(()=>{var f;(f=o.value)==null||f.cancel(),n.runAsync=d})}}),v(t)?{onCancel:()=>{var c;(c=o.value)==null||c.cancel()}}:{}},Z=(n,{loadingDelay:t})=>{const e=g();if(!v(t))return{};const s=()=>{e.value&&clearTimeout(e.value)};return{onBefore:()=>(s(),e.value=setTimeout(()=>{n.setState({loading:!0})},v(t)),{loading:!1}),onFinally:()=>{s()},onCancel:()=>{s()}}},y=(n,{pollingInterval:t,pollingWhenHidden:e=!0,pollingErrorRetryCount:s=-1})=>{const a=g(),o=g(),i=g(0),c=()=>{var d;a.value&&clearInterval(a.value),(d=o.value)==null||d.call(o)};return A(()=>{v(t)||c()}),v(t)?{onBefore:()=>{c()},onError:()=>{i.value+=1},onSuccess:()=>{i.value=0},onFinally:()=>{s===-1||s!==-1&&i.value<=s?a.value=setTimeout(()=>{!e&&!_()?o.value=M(()=>{n.refresh()}):n.refresh()},v(t)):i.value=0},onCancel:()=>{c()}}:{}};function G(n,t){let e=!1;return(...s)=>{e||(e=!0,n(...s),setTimeout(()=>{e=!1},t))}}const W=(n,{refreshOnWindowFocus:t,focusTimespan:e=5e3})=>{const s=g(),a=()=>{var o;(o=s.value)==null||o.call(s)};return A(o=>{if(v(t)){const i=G(n.refresh.bind(n),v(e));s.value=E(()=>{i()})}o(()=>{a()})}),T(()=>{a()}),{}},k=(n,{retryInterval:t,retryCount:e})=>{const s=g(),a=g(0),o=g(!1);return e?{onBefore:()=>{o.value||(a.value=0),o.value=!1,s.value&&clearTimeout(s.value)},onSuccess:()=>{a.value=0},onError:()=>{if(a.value+=1,e===-1||a.value<=e){const i=t!=null?t:Math.min(1e3*2**a.value,3e4);s.value=setTimeout(()=>{o.value=!0,n.refresh()},i)}else a.value=0},onCancel:()=>{a.value=0,s.value&&clearTimeout(s.value)}}:{}},I=(n,{throttleWait:t,throttleLeading:e,throttleTrailing:s})=>{const a=C(()=>{const i={};return v(e)!==void 0&&(i.leading=v(e)),v(s)!==void 0&&(i.trailing=v(s)),i}),o=C(()=>$(i=>{i()},v(t),a.value));return A(i=>{if(v(t)){const c=n.runAsync.bind(n);n.runAsync=(...d)=>new Promise((f,l)=>{var u;(u=o.value)==null||u.call(o,()=>{c(...d).then(f).catch(l)})}),i(()=>{var d;n.runAsync=c,(d=o.value)==null||d.cancel()})}}),v(t)?{onCancel:()=>{var i;(i=o.value)==null||i.cancel()}}:{}};class K{constructor(t,e,s,a={}){R(this,"pluginImpls");R(this,"count",0);R(this,"state",{loading:!1,params:void 0,data:void 0,error:void 0});this.serviceRef=t,this.options=e,this.setUpdataData=s,this.initState=a,this.state={...this.state,loading:!e.manual,...a}}setState(t={}){this.state={...this.state,...t},this.setUpdataData(this.state)}setData(t,e){e instanceof Array?e.forEach(s=>{this.state[s]=t,this.setUpdataData(t,s)}):(this.state[e]=t,this.setUpdataData(t,e))}runPluginHandler(t,...e){var a,o,i;const s=(i=(o=(a=this.pluginImpls)==null?void 0:a.map(c=>{var d;return(d=c[t])==null?void 0:d.call(c,...e)}))!=null?o:[])==null?void 0:i.filter(Boolean);return Object.assign({},...s)}async runAsync(...t){var i,c,d,f,l,u,r,m,P,D;this.count+=1;const e=this.count,{stopNow:s=!1,returnNow:a=!1,...o}=this.runPluginHandler("onBefore",t);if(s)return new Promise(()=>{});if(this.setState({loading:!0,params:t,...o}),a)return Promise.resolve(o.data);(c=(i=this.options).onBefore)==null||c.call(i,t);try{let{servicePromise:h}=this.runPluginHandler("onRequest",this.serviceRef.value,t);h||(h=this.serviceRef.value(...t));const F=await h;if(e!==this.count)return new Promise(()=>{});const w=this.options.formatResult?this.options.formatResult(F):F;return this.setState({data:w,error:void 0,loading:!1}),(f=(d=this.options).onSuccess)==null||f.call(d,w,t),this.runPluginHandler("onSuccess",w,t),(u=(l=this.options).onFinally)==null||u.call(l,t,w,void 0),e===this.count&&this.runPluginHandler("onFinally",t,w,void 0),w}catch(h){if(e!==this.count)return new Promise(()=>{});throw this.setState({error:h,loading:!1}),(m=(r=this.options).onError)==null||m.call(r,h,t),this.runPluginHandler("onError",h,t),(D=(P=this.options).onFinally)==null||D.call(P,t,void 0,h),e===this.count&&this.runPluginHandler("onFinally",t,void 0,h),h}}run(...t){this.runAsync(...t).catch(e=>{this.options.onError||console.error(e)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(t){let e;typeof t=="function"?e=t==null?void 0:t(this.state.data):e=t,this.runPluginHandler("onMutate",e),this.setState({data:e})}}function tt(n,t={},e=[]){const{initialData:s=void 0,manual:a=!1,ready:o=!0,...i}=t,c={manual:a,ready:o,...i},d=g(n),f=U({data:s,loading:!1,params:void 0,error:void 0}),l=(m,P)=>{P?f[P]=m:(f.data=m.data,f.loading=m.loading,f.error=m.error,f.params=m.params)},u=e.map(m=>{var P;return(P=m==null?void 0:m.onInit)==null?void 0:P.call(m,c)}).filter(Boolean),r=new K(d,c,l,Object.assign({},...u,f));return r.options=c,r.pluginImpls=e.map(m=>m(r,c)),j(()=>{if(!a){const m=r.state.params||t.defaultParams||[];v(o)&&r.run(...m)}}),T(()=>{r.cancel()}),{...q(f),cancel:r.cancel.bind(r),refresh:r.refresh.bind(r),refreshAsync:r.refreshAsync.bind(r),run:r.run.bind(r),runAsync:r.runAsync.bind(r),mutate:r.mutate.bind(r)}}function rt(n,t,e){return tt(n,t,[...e||[],Y,Z,y,W,I,x,X,k])}export{rt as u};
