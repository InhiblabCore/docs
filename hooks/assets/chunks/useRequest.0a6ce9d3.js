var H=Object.defineProperty;var F=(n,t,e)=>t in n?H(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var R=(n,t,e)=>(F(n,typeof t!="symbol"?t+"":t,e),e);import{d as U,s as M,f as j,u as q}from"./stringify.4212bd8e.js";import{r as g,l as A,k as D,s as b,u as v,A as x,B as N,h as L,C as V}from"../app.d255f7e5.js";import{d as y}from"./debounce.1f88286d.js";import{t as Y}from"./throttle.2f1674df.js";const S=new Map,$=(n,t,e)=>{const s=S.get(n);s!=null&&s.timer&&clearTimeout(s.timer);let a;t>-1&&(a=setTimeout(()=>{S.delete(n)},t)),S.set(n,{...e,timer:a})},Q=n=>S.get(n),_=new Map,z=n=>_.get(n),G=(n,t)=>{_.set(n,t),t.then(e=>(_.delete(n),e)).catch(e=>{throw _.delete(n),e})},p={},J=(n,t)=>{p[n]&&p[n].forEach(e=>e(t))},O=(n,t)=>(p[n]||(p[n]=[]),p[n].push(t),function(){const s=p[n].indexOf(t);p[n].splice(s,1)}),X=(n,{cacheKey:t,cacheTime:e=5*60*1e3,staleTime:s=0,setCache:a,getCache:o})=>{const i=g(),c=g(),f=(r,u)=>{a?a(u):$(r,e,u),J(r,u.data)},m=(r,u=[])=>o?o(u):Q(r);return A(()=>{if(!t)return;const r=m(t);r&&Object.hasOwnProperty.call(r,"data")&&(n.state.data=r.data,n.state.params=r.params,(s===-1||new Date().getTime()-r.time<=s)&&(n.state.loading=!1)),i.value=O(t,u=>{n.setState({data:u})})}),D(()=>{var r;(r=i.value)==null||r.call(i)}),t?{onBefore:r=>{const u=m(t,r);return!u||!Object.hasOwnProperty.call(u,"data")?{}:s===-1||new Date().getTime()-u.time<=s?{loading:!1,data:u==null?void 0:u.data,returnNow:!0}:{data:u==null?void 0:u.data}},onRequest:(r,u)=>{let l=z(t);return l&&l!==c.value?{servicePromise:l}:(l=r(...u),c.value=l,G(t,l),{servicePromise:l})},onSuccess:(r,u)=>{var l;t&&((l=i.value)==null||l.call(i),f(t,{data:r,params:u,time:new Date().getTime()}),i.value=O(t,d=>{n.setState({data:d})}))},onMutate:r=>{var u;t&&((u=i.value)==null||u.call(i),f(t,{data:r,params:n.state.params,time:new Date().getTime()}),i.value=O(t,l=>{n.setState({data:l})}))}}:{}},Z=(n,{debounceWait:t,debounceLeading:e,debounceTrailing:s,debounceMaxWait:a})=>{const o=g(),i=b(()=>{const c={},f=v(e),m=v(s),r=v(a);return f!==void 0&&(c.leading=f),m!==void 0&&(c.trailing=m),r!==void 0&&(c.maxWait=r),c});return A(c=>{if(v(t)){const f=n.runAsync.bind(n);o.value=y(m=>{m()},v(t),i.value),n.runAsync=(...m)=>new Promise((r,u)=>{var l;(l=o.value)==null||l.call(o,()=>{f(...m).then(r).catch(u)})}),c(()=>{var m;(m=o.value)==null||m.cancel(),n.runAsync=f})}}),v(t)?{onCancel:()=>{var c;(c=o.value)==null||c.cancel()}}:{}},W=(n,{loadingDelay:t})=>{const e=g();if(!v(t))return{};const s=()=>{e.value&&clearTimeout(e.value)};return{onBefore:()=>(s(),e.value=setTimeout(()=>{n.setState({loading:!0})},v(t)),{loading:!1}),onFinally:()=>{s()},onCancel:()=>{s()}}},I=(n,{pollingInterval:t,pollingWhenHidden:e=!0,pollingErrorRetryCount:s=-1})=>{const a=g(),o=g(),i=g(0),c=()=>{var f;a.value&&clearInterval(a.value),(f=o.value)==null||f.call(o)};return A(()=>{v(t)||c()}),v(t)?{onBefore:()=>{c()},onError:()=>{i.value+=1},onSuccess:()=>{i.value=0},onFinally:()=>{s===-1||s!==-1&&i.value<=s?a.value=setTimeout(()=>{!e&&!U()?o.value=M(()=>{n.refresh()}):n.refresh()},v(t)):i.value=0},onCancel:()=>{c()}}:{}};function k(n,t){let e=!1;return(...s)=>{e||(e=!0,n(...s),setTimeout(()=>{e=!1},t))}}const K=(n,{refreshOnWindowFocus:t,focusTimespan:e=5e3})=>{const s=g(),a=()=>{var o;(o=s.value)==null||o.call(s)};return A(o=>{if(v(t)){const i=k(n.refresh.bind(n),v(e));s.value=j(()=>{i()})}o(()=>{a()})}),D(()=>{a()}),{}},tt=(n,{retryInterval:t,retryCount:e})=>{const s=g(),a=g(0),o=g(!1);return e?{onBefore:()=>{o.value||(a.value=0),o.value=!1,s.value&&clearTimeout(s.value)},onSuccess:()=>{a.value=0},onError:()=>{if(a.value+=1,e===-1||a.value<=e){const i=t!=null?t:Math.min(1e3*2**a.value,3e4);s.value=setTimeout(()=>{o.value=!0,n.refresh()},i)}else a.value=0},onCancel:()=>{a.value=0,s.value&&clearTimeout(s.value)}}:{}},et=(n,{throttleWait:t,throttleLeading:e,throttleTrailing:s})=>{const a=b(()=>{const i={};return v(e)!==void 0&&(i.leading=v(e)),v(s)!==void 0&&(i.trailing=v(s)),i}),o=b(()=>Y(i=>{i()},v(t),a.value));return A(i=>{if(v(t)){const c=n.runAsync.bind(n);n.runAsync=(...f)=>new Promise((m,r)=>{var u;(u=o.value)==null||u.call(o,()=>{c(...f).then(m).catch(r)})}),i(()=>{var f;n.runAsync=c,(f=o.value)==null||f.cancel()})}}),v(t)?{onCancel:()=>{var i;(i=o.value)==null||i.cancel()}}:{}};class nt{constructor(t,e,s,a={}){R(this,"pluginImpls");R(this,"count",0);R(this,"state",{loading:!1,params:void 0,data:void 0,error:void 0});this.serviceRef=t,this.options=e,this.setUpdateData=s,this.initState=a,this.state={...this.state,loading:!e.manual,...a}}setState(t={}){this.state={...this.state,...t},this.setUpdateData(this.state)}setData(t,e){e instanceof Array?e.forEach(s=>{this.state[s]=t,this.setUpdateData(t,s)}):(this.state[e]=t,this.setUpdateData(t,e))}runPluginHandler(t,...e){var a,o,i;const s=(i=(o=(a=this.pluginImpls)==null?void 0:a.map(c=>{var f;return(f=c[t])==null?void 0:f.call(c,...e)}))!=null?o:[])==null?void 0:i.filter(Boolean);return Object.assign({},...s)}async runAsync(...t){var i,c,f,m,r,u;this.count+=1;const e=this.count,{stopNow:s=!1,returnNow:a=!1,...o}=this.runPluginHandler("onBefore",t);if(s)return new Promise(()=>{});if(this.setState({loading:!0,params:t,...o}),a)return Promise.resolve(o.data);(c=(i=this.options).onBefore)==null||c.call(i,t);try{let{servicePromise:l}=this.runPluginHandler("onRequest",this.serviceRef.value,t);const d=P=>{var E,T,B,C;if(e!==this.count)return new Promise(()=>{});const w=this.options.formatResult?this.options.formatResult(P):P;return this.setState({data:w,error:void 0,loading:!1}),(T=(E=this.options).onSuccess)==null||T.call(E,w,t),this.runPluginHandler("onSuccess",w,t),(C=(B=this.options).onFinally)==null||C.call(B,t,w,void 0),e===this.count&&this.runPluginHandler("onFinally",t,w,void 0),w};l||(!this.options.manual&&this.options.refreshDeps===!0?A(async()=>{if(v(this.options.ready)){this.setData(!0,"loading"),l=this.serviceRef.value(...t);const P=await l;return d(P)}}):l=this.serviceRef.value(...t));const h=await l;return d(h)}catch(l){if(e!==this.count)return new Promise(()=>{});throw this.setState({error:l,loading:!1}),(m=(f=this.options).onError)==null||m.call(f,l,t),this.runPluginHandler("onError",l,t),(u=(r=this.options).onFinally)==null||u.call(r,t,void 0,l),e===this.count&&this.runPluginHandler("onFinally",t,void 0,l),l}}run(...t){this.runAsync(...t).catch(e=>{this.options.onError||console.error(e)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(t){let e;typeof t=="function"?e=t==null?void 0:t(this.state.data):e=t,this.runPluginHandler("onMutate",e),this.setState({data:e})}}const st=Symbol("USEREQUEST_GLOBAL_OPTIONS_PROVIDE_KEY");function it(n,t={},e=[]){const s=x(st),{initialData:a=void 0,manual:o=!1,ready:i=!0,...c}={...s!=null?s:{},...t!=null?t:{}},f={manual:o,ready:i,...c},m=g(n),r=N({data:a,loading:!1,params:void 0,error:void 0}),u=(h,P)=>{P?r[P]=h:(r.data=h.data,r.loading=h.loading,r.error=h.error,r.params=h.params)},l=e.map(h=>{var P;return(P=h==null?void 0:h.onInit)==null?void 0:P.call(h,f)}).filter(Boolean),d=new nt(m,f,u,Object.assign({},...l,r));return d.options=f,d.pluginImpls=e.map(h=>h(d,f)),L(()=>{if(!o){const h=d.state.params||t.defaultParams||[];v(i)&&d.run(...h)}}),D(()=>{d.cancel()}),{...V(r),cancel:d.cancel.bind(d),refresh:d.refresh.bind(d),refreshAsync:d.refreshAsync.bind(d),run:d.run.bind(d),runAsync:d.runAsync.bind(d),mutate:d.mutate.bind(d)}}function ct(n,t,e){return it(n,t,[...e||[],Z,W,I,K,et,q,X,tt])}export{st as U,ct as u};
