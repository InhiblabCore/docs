var U=Object.defineProperty;var C=(s,e,t)=>e in s?U(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var A=(s,e,t)=>(C(s,typeof e!="symbol"?e+"":e,t),t);import{d as H,s as M,f as j,u as q}from"./stringify.678a69ff.js";import{r as g,l as R,k as b,s as _,u as h,A as x,B as N,h as y,C as L}from"../app.d255f7e5.js";import{d as V}from"./debounce.83d8c6ef.js";import{t as Y}from"./throttle.028b660b.js";const D=new Map,$=(s,e,t)=>{const n=D.get(s);n!=null&&n.timer&&clearTimeout(n.timer);let a;e>-1&&(a=setTimeout(()=>{D.delete(s)},e)),D.set(s,{...t,timer:a})},Q=s=>D.get(s),O=new Map,z=s=>O.get(s),G=(s,e)=>{O.set(s,e),e.then(t=>(O.delete(s),t)).catch(t=>{throw O.delete(s),t})},p={},J=(s,e)=>{p[s]&&p[s].forEach(t=>t(e))},S=(s,e)=>(p[s]||(p[s]=[]),p[s].push(e),function(){const n=p[s].indexOf(e);p[s].splice(n,1)}),X=(s,{cacheKey:e,cacheTime:t=5*60*1e3,staleTime:n=0,setCache:a,getCache:o})=>{const i=g(),c=g(),f=(r,u)=>{a?a(u):$(r,t,u),J(r,u.data)},v=(r,u=[])=>o?o(u):Q(r);return R(()=>{if(!e)return;const r=v(e);r&&Object.hasOwnProperty.call(r,"data")&&(s.state.data=r.data,s.state.params=r.params,(n===-1||new Date().getTime()-r.time<=n)&&(s.state.loading=!1)),i.value=S(e,u=>{s.setState({data:u})})}),b(()=>{var r;(r=i.value)==null||r.call(i)}),e?{onBefore:r=>{const u=v(e,r);return!u||!Object.hasOwnProperty.call(u,"data")?{}:n===-1||new Date().getTime()-u.time<=n?{loading:!1,data:u==null?void 0:u.data,returnNow:!0}:{data:u==null?void 0:u.data}},onRequest:(r,u)=>{let l=z(e);return l&&l!==c.value?{servicePromise:l}:(l=r(...u),c.value=l,G(e,l),{servicePromise:l})},onSuccess:(r,u)=>{var l;e&&((l=i.value)==null||l.call(i),f(e,{data:r,params:u,time:new Date().getTime()}),i.value=S(e,d=>{s.setState({data:d})}))},onMutate:r=>{var u;e&&((u=i.value)==null||u.call(i),f(e,{data:r,params:s.state.params,time:new Date().getTime()}),i.value=S(e,l=>{s.setState({data:l})}))}}:{}},Z=(s,{debounceWait:e,debounceLeading:t,debounceTrailing:n,debounceMaxWait:a})=>{const o=g(),i=_(()=>{const c={},f=h(t),v=h(n),r=h(a);return f!==void 0&&(c.leading=f),v!==void 0&&(c.trailing=v),r!==void 0&&(c.maxWait=r),c});return R(c=>{if(h(e)){const f=s.runAsync.bind(s);o.value=V(v=>{v()},h(e),i.value),s.runAsync=(...v)=>new Promise((r,u)=>{var l;(l=o.value)==null||l.call(o,()=>{f(...v).then(r).catch(u)})}),c(()=>{var v;(v=o.value)==null||v.cancel(),s.runAsync=f})}}),h(e)?{onCancel:()=>{var c;(c=o.value)==null||c.cancel()}}:{}},W=(s,{loadingDelay:e})=>{const t=g();if(!h(e))return{};const n=()=>{t.value&&clearTimeout(t.value)};return{onBefore:()=>(n(),t.value=setTimeout(()=>{s.setState({loading:!0})},h(e)),{loading:!1}),onFinally:()=>{n()},onCancel:()=>{n()}}},I=(s,{pollingInterval:e,pollingWhenHidden:t=!0,pollingErrorRetryCount:n=-1})=>{const a=g(),o=g(),i=g(0),c=()=>{var f;a.value&&clearInterval(a.value),(f=o.value)==null||f.call(o)};return R(()=>{h(e)||c()}),h(e)?{onBefore:()=>{c()},onError:()=>{i.value+=1},onSuccess:()=>{i.value=0},onFinally:()=>{n===-1||n!==-1&&i.value<=n?a.value=setTimeout(()=>{!t&&!H()?o.value=M(()=>{s.refresh()}):s.refresh()},h(e)):i.value=0},onCancel:()=>{c()}}:{}};function k(s,e){let t=!1;return(...n)=>{t||(t=!0,s(...n),setTimeout(()=>{t=!1},e))}}const K=(s,{refreshOnWindowFocus:e,focusTimespan:t=5e3})=>{const n=g(),a=()=>{var o;(o=n.value)==null||o.call(n)};return R(o=>{if(h(e)){const i=k(s.refresh.bind(s),h(t));n.value=j(()=>{i()})}o(()=>{a()})}),b(()=>{a()}),{}},ee=(s,{retryInterval:e,retryCount:t})=>{const n=g(),a=g(0),o=g(!1);return t?{onBefore:()=>{o.value||(a.value=0),o.value=!1,n.value&&clearTimeout(n.value)},onSuccess:()=>{a.value=0},onError:()=>{if(a.value+=1,t===-1||a.value<=t){const i=e!=null?e:Math.min(1e3*2**a.value,3e4);n.value=setTimeout(()=>{o.value=!0,s.refresh()},i)}else a.value=0},onCancel:()=>{a.value=0,n.value&&clearTimeout(n.value)}}:{}},te=(s,{throttleWait:e,throttleLeading:t,throttleTrailing:n})=>{const a=_(()=>{const i={};return h(t)!==void 0&&(i.leading=h(t)),h(n)!==void 0&&(i.trailing=h(n)),i}),o=_(()=>Y(i=>{i()},h(e),a.value));return R(i=>{if(h(e)){const c=s.runAsync.bind(s);s.runAsync=(...f)=>new Promise((v,r)=>{var u;(u=o.value)==null||u.call(o,()=>{c(...f).then(v).catch(r)})}),i(()=>{var f;s.runAsync=c,(f=o.value)==null||f.cancel()})}}),h(e)?{onCancel:()=>{var i;(i=o.value)==null||i.cancel()}}:{}};class se{constructor(e,t,n,a={}){A(this,"pluginImpls");A(this,"count",0);A(this,"state",{loading:!1,params:void 0,data:void 0,error:void 0});this.serviceRef=e,this.options=t,this.setUpdateData=n,this.initState=a,this.state={...this.state,loading:!t.manual,...a}}setState(e={}){this.state={...this.state,...e},this.setUpdateData(this.state)}setData(e,t){console.warn("Please use 'setFetchState' instead of 'setData'"),t instanceof Array?t.forEach(n=>{this.state[n]=e,this.setUpdateData(e,n)}):(this.state[t]=e,this.setUpdateData(e,t))}setFetchState(e,t){t instanceof Array?t.forEach(n=>{this.state[n]=e,this.setUpdateData(e,n)}):(this.state[t]=e,this.setUpdateData(e,t))}runPluginHandler(e,...t){var a,o,i;const n=(i=(o=(a=this.pluginImpls)==null?void 0:a.map(c=>{var f;return(f=c[e])==null?void 0:f.call(c,...t)}))!=null?o:[])==null?void 0:i.filter(Boolean);return Object.assign({},...n)}async runAsync(...e){var i,c,f,v,r,u;this.count+=1;const t=this.count,{stopNow:n=!1,returnNow:a=!1,...o}=this.runPluginHandler("onBefore",e);if(n)return new Promise(()=>{});if(this.setState({loading:!0,params:e,...o}),a)return Promise.resolve(o.data);(c=(i=this.options).onBefore)==null||c.call(i,e);try{let{servicePromise:l}=this.runPluginHandler("onRequest",this.serviceRef.value,e);const d=P=>{var E,T,F,B;if(t!==this.count)return new Promise(()=>{});const w=this.options.formatResult?this.options.formatResult(P):P;return this.setState({data:w,error:void 0,loading:!1}),(T=(E=this.options).onSuccess)==null||T.call(E,w,e),this.runPluginHandler("onSuccess",w,e),(B=(F=this.options).onFinally)==null||B.call(F,e,w,void 0),t===this.count&&this.runPluginHandler("onFinally",e,w,void 0),w};l||(!this.options.manual&&this.options.refreshDeps===!0?R(async()=>{if(h(this.options.ready)){this.setFetchState(!0,"loading"),l=this.serviceRef.value(...e);const P=await l;return d(P)}}):l=this.serviceRef.value(...e));const m=await l;return d(m)}catch(l){if(t!==this.count)return new Promise(()=>{});throw this.setState({error:l,loading:!1}),(v=(f=this.options).onError)==null||v.call(f,l,e),this.runPluginHandler("onError",l,e),(u=(r=this.options).onFinally)==null||u.call(r,e,void 0,l),t===this.count&&this.runPluginHandler("onFinally",e,void 0,l),l}}run(...e){this.runAsync(...e).catch(t=>{this.options.onError||console.error(t)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(e){let t;typeof e=="function"?t=e==null?void 0:e(this.state.data):t=e,this.runPluginHandler("onMutate",t),this.setState({data:t})}}const ne=Symbol("USEREQUEST_GLOBAL_OPTIONS_PROVIDE_KEY");function ie(s){return Object.keys(s).filter(t=>["data","loading","params","error"].includes(t)).length===4}function re(s,e={},t=[]){const n=x(ne,{}),{initialData:a=void 0,manual:o=!1,ready:i=!0,...c}={...n!=null?n:{},...e!=null?e:{}},f={manual:o,ready:i,...c},v=g(s),r=N({data:a,loading:!1,params:void 0,error:void 0}),u=(m,P)=>{P?r[P]=m:ie(m)&&(r.data=m.data,r.loading=m.loading,r.error=m.error,r.params=m.params)},l=t.map(m=>{var P;return(P=m==null?void 0:m.onInit)==null?void 0:P.call(m,f)}).filter(Boolean),d=new se(v,f,u,Object.assign({},...l,r));return d.options=f,d.pluginImpls=t.map(m=>m(d,f)),y(()=>{if(!o){const m=d.state.params||e.defaultParams||[];h(i)&&d.run(...m)}}),b(()=>{d.cancel()}),{...L(r),cancel:d.cancel.bind(d),refresh:d.refresh.bind(d),refreshAsync:d.refreshAsync.bind(d),run:d.run.bind(d),runAsync:d.runAsync.bind(d),mutate:d.mutate.bind(d)}}function fe(s,e,t){return re(s,e,[...t||[],Z,W,I,K,te,q,X,ee])}export{ne as U,fe as u};
