var F=Object.defineProperty;var U=(s,e,t)=>e in s?F(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var R=(s,e,t)=>(U(s,typeof e!="symbol"?e+"":e,t),t);import{d as H,s as j,f as M,u as q}from"./stringify.dafbd646.js";import{r as P,l as w,k as E,s as O,u as m,A as x,B as N,j as L,h as V,C as y}from"../app.a751dad7.js";import{d as Y}from"./debounce.2ed8e492.js";import{t as $}from"./throttle.e988d28f.js";const A=new Map,Q=(s,e,t)=>{const n=A.get(s);n!=null&&n.timer&&clearTimeout(n.timer);let a;e>-1&&(a=setTimeout(()=>{A.delete(s)},e)),A.set(s,{...t,timer:a})},z=s=>A.get(s),D=new Map,G=s=>D.get(s),J=(s,e)=>{D.set(s,e),e.then(t=>(D.delete(s),t)).catch(t=>{throw D.delete(s),t})},p={},X=(s,e)=>{p[s]&&p[s].forEach(t=>t(e))},b=(s,e)=>(p[s]||(p[s]=[]),p[s].push(e),function(){const n=p[s].indexOf(e);p[s].splice(n,1)}),Z=(s,{cacheKey:e,cacheTime:t=5*60*1e3,staleTime:n=0,setCache:a,getCache:r})=>{const i=P(),l=P(),f=(o,u)=>{a?a(u):Q(o,t,u),X(o,u.data)},h=(o,u=[])=>r?r(u):z(o);return w(()=>{if(!e)return;const o=h(e);o&&Object.hasOwnProperty.call(o,"data")&&(s.state.data=o.data,s.state.params=o.params,(n===-1||new Date().getTime()-o.time<=n)&&(s.state.loading=!1)),i.value=b(e,u=>{s.setState({data:u})})}),E(()=>{var o;(o=i.value)==null||o.call(i)}),e?{onBefore:o=>{const u=h(e,o);return!u||!Object.hasOwnProperty.call(u,"data")?{}:n===-1||new Date().getTime()-u.time<=n?{loading:!1,data:u==null?void 0:u.data,returnNow:!0}:{data:u==null?void 0:u.data}},onRequest:(o,u)=>{let c=G(e);return c&&c!==l.value?{servicePromise:c}:(c=o(...u),l.value=c,J(e,c),{servicePromise:c})},onSuccess:(o,u)=>{var c;e&&((c=i.value)==null||c.call(i),f(e,{data:o,params:u,time:new Date().getTime()}),i.value=b(e,d=>{s.setState({data:d})}))},onMutate:o=>{var u;e&&((u=i.value)==null||u.call(i),f(e,{data:o,params:s.state.params,time:new Date().getTime()}),i.value=b(e,c=>{s.setState({data:c})}))}}:{}},W=(s,{debounceWait:e,debounceLeading:t,debounceTrailing:n,debounceMaxWait:a})=>{const r=P(),i=O(()=>{const l={},f=m(t),h=m(n),o=m(a);return f!==void 0&&(l.leading=f),h!==void 0&&(l.trailing=h),o!==void 0&&(l.maxWait=o),l});return w(l=>{if(m(e)){const f=s.runAsync.bind(s);r.value=Y(h=>{h()},m(e),i.value),s.runAsync=(...h)=>new Promise((o,u)=>{var c;(c=r.value)==null||c.call(r,()=>{f(...h).then(o).catch(u)})}),l(()=>{var h;(h=r.value)==null||h.cancel(),s.runAsync=f})}}),m(e)?{onCancel:()=>{var l;(l=r.value)==null||l.cancel()}}:{}},I=(s,{loadingDelay:e})=>{const t=P();if(!m(e))return{};const n=()=>{t.value&&clearTimeout(t.value)};return{onBefore:()=>(n(),t.value=setTimeout(()=>{s.setState({loading:!0})},m(e)),{loading:!1}),onFinally:()=>{n()},onCancel:()=>{n()}}},k=(s,{pollingInterval:e,pollingWhenHidden:t=!0,pollingErrorRetryCount:n=-1})=>{const a=P(),r=P(),i=P(0),l=()=>{var f;a.value&&clearInterval(a.value),(f=r.value)==null||f.call(r)};return w(()=>{m(e)||l()}),m(e)?{onBefore:()=>{l()},onError:()=>{i.value+=1},onSuccess:()=>{i.value=0},onFinally:()=>{n===-1||n!==-1&&i.value<=n?a.value=setTimeout(()=>{!t&&!H()?r.value=j(()=>{s.refresh()}):s.refresh()},m(e)):i.value=0},onCancel:()=>{l()}}:{}};function K(s,e){let t=!1;return(...n)=>{t||(t=!0,s(...n),setTimeout(()=>{t=!1},e))}}const ee=(s,{refreshOnWindowFocus:e,focusTimespan:t=5e3})=>{const n=P(),a=()=>{var r;(r=n.value)==null||r.call(n)};return w(r=>{if(m(e)){const i=K(s.refresh.bind(s),m(t));n.value=M(()=>{i()})}r(()=>{a()})}),E(()=>{a()}),{}},te=(s,{retryInterval:e,retryCount:t})=>{const n=P(),a=P(0),r=P(!1);return t?{onBefore:()=>{r.value||(a.value=0),r.value=!1,n.value&&clearTimeout(n.value)},onSuccess:()=>{a.value=0},onError:()=>{if(a.value+=1,t===-1||a.value<=t){const i=e!=null?e:Math.min(1e3*2**a.value,3e4);n.value=setTimeout(()=>{r.value=!0,s.refresh()},i)}else a.value=0},onCancel:()=>{a.value=0,n.value&&clearTimeout(n.value)}}:{}},se=(s,{throttleWait:e,throttleLeading:t,throttleTrailing:n})=>{const a=O(()=>{const i={};return m(t)!==void 0&&(i.leading=m(t)),m(n)!==void 0&&(i.trailing=m(n)),i}),r=O(()=>$(i=>{i()},m(e),a.value));return w(i=>{if(m(e)){const l=s.runAsync.bind(s);s.runAsync=(...f)=>new Promise((h,o)=>{var u;(u=r.value)==null||u.call(r,()=>{l(...f).then(h).catch(o)})}),i(()=>{var f;s.runAsync=l,(f=r.value)==null||f.cancel()})}}),m(e)?{onCancel:()=>{var i;(i=r.value)==null||i.cancel()}}:{}};class ne{constructor(e,t,n,a={}){R(this,"pluginImpls");R(this,"count",0);R(this,"state",{loading:!1,params:void 0,data:void 0,error:void 0});this.serviceRef=e,this.options=t,this.setUpdateData=n,this.initState=a,this.state={...this.state,loading:!t.manual,...a}}setState(e={}){this.state={...this.state,...e},this.setUpdateData(this.state)}setData(e,t){console.warn("Please use 'setFetchState' instead of 'setData'"),t instanceof Array?t.forEach(n=>{this.state[n]=e,this.setUpdateData(e,n)}):(this.state[t]=e,this.setUpdateData(e,t))}setFetchState(e,t){t instanceof Array?t.forEach(n=>{this.state[n]=e,this.setUpdateData(e,n)}):(this.state[t]=e,this.setUpdateData(e,t))}runPluginHandler(e,...t){var a,r,i;const n=(i=(r=(a=this.pluginImpls)==null?void 0:a.map(l=>{var f;return(f=l[e])==null?void 0:f.call(l,...t)}))!=null?r:[])==null?void 0:i.filter(Boolean);return Object.assign({},...n)}async runAsync(...e){var i,l,f,h,o,u;this.count+=1;const t=this.count,{stopNow:n=!1,returnNow:a=!1,...r}=this.runPluginHandler("onBefore",e);if(n)return new Promise(()=>{});if(this.setState({loading:!0,params:e,...r}),a)return Promise.resolve(r.data);(l=(i=this.options).onBefore)==null||l.call(i,e);try{let{servicePromise:c}=this.runPluginHandler("onRequest",this.serviceRef.value,e);const d=v=>{var S,T,B,C;if(t!==this.count)return new Promise(()=>{});const g=this.options.formatResult?this.options.formatResult(v):v;return this.setState({data:g,error:void 0,loading:!1}),(T=(S=this.options).onSuccess)==null||T.call(S,g,e),this.runPluginHandler("onSuccess",g,e),(C=(B=this.options).onFinally)==null||C.call(B,e,g,void 0),t===this.count&&this.runPluginHandler("onFinally",e,g,void 0),g};c||(c=this.serviceRef.value(...e));const _=await c;return d(_)}catch(c){if(t!==this.count)return new Promise(()=>{});throw this.setState({error:c,loading:!1}),(h=(f=this.options).onError)==null||h.call(f,c,e),this.runPluginHandler("onError",c,e),(u=(o=this.options).onFinally)==null||u.call(o,e,void 0,c),t===this.count&&this.runPluginHandler("onFinally",e,void 0,c),c}}run(...e){this.runAsync(...e).catch(t=>{this.options.onError||console.error(t)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(e){let t;typeof e=="function"?t=e==null?void 0:e(this.state.data):t=e,this.runPluginHandler("onMutate",t),this.setState({data:t})}}const ie=Symbol("USEREQUEST_GLOBAL_OPTIONS_PROVIDE_KEY");function re(s){return Object.keys(s).filter(t=>["data","loading","params","error"].includes(t)).length===4}function oe(s,e={},t=[]){const n=x(ie,{}),{initialData:a=void 0,manual:r=!1,ready:i=!0,...l}={...n!=null?n:{},...e!=null?e:{}},f={manual:r,ready:i,...l},h=P(s),o=N({data:a,loading:!1,params:void 0,error:void 0}),u=(v,g)=>{g?o[g]=v:re(v)&&(o.data=v.data,o.loading=v.loading,o.error=v.error,o.params=v.params)},c=t.map(v=>{var g;return(g=v==null?void 0:v.onInit)==null?void 0:g.call(v,f)}).filter(Boolean),d=new ne(h,f,u,Object.assign({},...c,o));d.options=f,d.pluginImpls=t.map(v=>v(d,f));const _=O(()=>L(i)?i.value:i);return w(()=>{if(!r){const v=d.state.params||e.defaultParams||[];_.value&&d.options.refreshDeps===!0&&!!h.value&&d.run(...v)}}),V(()=>{if(!r){const v=d.state.params||e.defaultParams||[];m(i)&&d.run(...v)}}),E(()=>{d.cancel()}),{...y(o),cancel:d.cancel.bind(d),refresh:d.refresh.bind(d),refreshAsync:d.refreshAsync.bind(d),run:d.run.bind(d),runAsync:d.runAsync.bind(d),mutate:d.mutate.bind(d)}}function de(s,e,t){return oe(s,e,[...t||[],W,I,k,ee,se,q,Z,te])}export{ie as U,de as u};
